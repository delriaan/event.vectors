---
title: "Continuity Example"
output: rmarkdown::html_vignette
vignette: >
 %\VignetteIndexEntry{Continuity Example}
 %\VignetteIndexEngine{knitr::rmarkdown}
 %\VignetteEncoding{UTF-8}
---

```{r, echo=FALSE, warning=FALSE}
library(stringi, include.only = "%s+%");
library(magrittr);
library(purrr);
library(event.vectors);
knitr::opts_chunk$set(collapse = TRUE, comment = "#>", message = FALSE, warning=FALSE);
htmltools::tags$style(readLines(Sys.getenv("CSS")) |> paste(collapse = "\n")) |> htmltools::tagList();
make.test_data <- function(j = 5, n = 5, m = 5, o = 1:10, dest = globalenv(), .debug = FALSE){
#' Make Test Data for Validation
#'
#' \code{make.test_data} creates several \code{\link[data.table]{data.table}} objects to be used to validate the package functionality
#' @param j (integer | 5L) The number of unique values for 'k' to generate
#' @param n (integer | 5L) The number of sources to create (maximum of 10)
#' @param m (integer | 5L) The maximum number of columns to generate for each created object (maximum of 15): each column represents an attribute not related to time
#' @param o (integer[] | 1:10) A vector of integers sampled to create end dates from a randomly-generated start date
#' @param dest (environment) The destination environment object
#' @param .debug (logical | \code{FALSE}) When \code{TRUE}, additional debugging items are printed
#'
#' @return One to \code{n} \code{\link[data.table]{data.table}} objects prefixed as 'test_data'.
#'
	j = max(c(3, abs(as.integer(j))));
	n = max(c(3, abs(as.integer(n)))); ifelse(n > 10, 10, n);
	m = max(c(3, abs(as.integer(m)))); ifelse(m > 15, 15, m);
	o = { ifelse(
					rlang::has_length(o, 1L)
					, yes = 1:10
					, no = ifelse(
							any(o <= 0)
						 	, yes = abs(o)
						 	, no = ifelse(
						 			rlang::has_length(o, 2L)
						 			, yes = `:`(o[1], o[2]) |> sort()
						 			, no =  o
						 			))
				)
		}

	sequence(n) %>%
	purrr::set_names(paste0("test_data.", stringi::stri_pad_left(., width = 2, pad = "0")))|>
	purrr::map(~{
		set.seed(90210);
		.src = LETTERS[[.x]];

		.out = purrr::map_dfr(c(1:j), ~list(join_key = rep.int(.x, sample(10:100, 1, TRUE)), src = .src)) %>% data.table::as.data.table();

		.init_date = c(as.Date(sprintf(
				"%s-%s-%s"
				, rep.int(data.table::year(Sys.Date()), nrow(.out))
				, sample(stringi::stri_pad_left(1:12, width = 2, pad = "0"), nrow(.out), TRUE)
				, sample(stringi::stri_pad_left(1:28, width = 2, pad = "0"), nrow(.out), TRUE)
				)));

		.out[
			, c("date.start", "date.end") := list(.init_date, .init_date + rpois(n = length(join_key), lambda = sample(o, length(join_key), TRUE)))
			][
			, paste0("X_", stringi::stri_pad_left(sample(30, m), width = 2, pad = "0")) := purrr::map(1:m, ~sample(runif(1E6), .N, TRUE))
			][
			runif(length(join_key)) > 0.65
			] %>%
			data.table::setkey(join_key, src, date.start, date.end) %>%
			data.table::setcolorder(c("join_key", "date.start", "date.end", "src"))
		}) %>%
	list2env(envir = dest);
}

```

# Example 

Starting with synthesized data, a `timeout` of 10 (days) will be used to roll up series of start and end dates into larger epochs.

The data will be processed under imputed groups defined by columns `join_key` and `src`.

```{r CONTINUITY_RUN, warning=FALSE}
make.test_data(j = 50, n = 1, m = 5, o = c(5, 20), dest = .GlobalEnv, .debug = !TRUE);

data.table::copy(test_data.01) |>
	continuity(
		map_fields = c(join_key, src)
		, time_fields = c(date.start, date.end)
		, boundary_name = episode
		, timeout = 10
		, archipelago = TRUE
		, show.all = !TRUE
		) %>%
	DT::datatable(
		options = list(
				dom = "rtip"
				, scroller = TRUE
				, scrollY = 200
				)
		, rownames = FALSE
		, extensions = c("Responsive", "Scroller")
		, width = 1154 *.8
		, height = 800 * .9
		)
```

Is the timeout choice of `10` the best choice given the grouping tuple ($\big\{\text{join_key};\enspace \text{Z_1}\big\}_i$)?  Answering that requires comparing imputed "islands" to some independent, adjudicating set of data or domain expert that can provide an assessment of reasonableness.  An alternative method would be to set the timeout by means of statistical analysis.  See [Break Signal](Break-Signal.html) for an example.